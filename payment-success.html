<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Muzimake</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="media/logo-icon-black.png">
    <link rel="icon" type="image/png" sizes="16x16" href="media/logo-icon-black.png">
    <link rel="apple-touch-icon" sizes="180x180" href="media/logo-icon-white.png">
    <link rel="icon" type="image/png" sizes="192x192" href="media/logo-icon-black.png">
    <link rel="icon" type="image/png" sizes="512x512" href="media/logo-icon-black.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'custom-beige': '#f3f1eb',
                        'custom-dark': '#080808',
                        'custom-gray': '#232321',
                        'custom-blue': '#0056fc',
                        'custom-orange': '#fc6900',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-extrabold { font-weight: 800; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        
        .success-animation {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body class="font-inter bg-custom-beige min-h-screen flex items-center justify-center">
    <div class="max-w-md mx-auto p-8 text-center">
        <!-- Success Icon -->
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 success-animation">
            <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        
        <!-- Dynamic Message -->
        <h1 id="status-title" class="text-custom-dark text-3xl font-bold mb-4">Finalizing your payment…</h1>
        <p id="status-subtitle" class="text-custom-gray text-lg mb-8">Please wait while we confirm your payment and update your order.</p>
        
        <!-- Order Details -->
        <div class="bg-white rounded-2xl p-6 mb-8 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-custom-dark text-xl font-bold">What's Next?</h2>
                <span id="db-status-pill" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-200">status: checking…</span>
            </div>
            <div class="space-y-3 text-sm text-custom-gray text-left">
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-custom-orange text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">1</div>
                    <p>You'll receive a confirmation email with your order details</p>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-custom-orange text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">2</div>
                    <p>Our team will start working on your custom song</p>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 bg-custom-orange text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">3</div>
                    <p>You'll receive your completed song within 3 days</p>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="space-y-4">
            <button id="home-btn" onclick="goToHome()" class="w-full bg-custom-orange text-white px-8 py-4 rounded-full font-semibold hover:bg-orange-600 transition-colors" disabled>
                Go to Homepage
            </button>
            <button id="how-btn" onclick="goToHowItWorks()" class="w-full bg-white text-custom-dark px-8 py-4 rounded-full font-semibold border border-gray-300 hover:bg-gray-50 transition-colors" disabled>
                Learn More About Our Process
            </button>
        </div>
        
        <!-- Contact Info -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <p class="text-sm text-custom-gray mb-2">Questions about your order?</p>
            <p class="text-sm text-custom-gray">Contact us at <a href="mailto:support@muzimake.com" class="text-custom-orange hover:underline">support@muzimake.com</a></p>
        </div>
    </div>

    <script>
        // Handle payment success
        document.addEventListener('DOMContentLoaded', async function() {
            const titleEl = document.getElementById('status-title');
            const subEl = document.getElementById('status-subtitle');
            const pillEl = document.getElementById('db-status-pill');
            const homeBtn = document.getElementById('home-btn');
            const howBtn = document.getElementById('how-btn');

            const urlParams = new URLSearchParams(window.location.search);
            const paymentId = urlParams.get('payment_id') || urlParams.get('id') || null;
            const orderId = urlParams.get('order_id') || null;
            const sessionId = urlParams.get('session_id') || null;

            // Confirm session on server (idempotent)
            try {
                if (sessionId) {
                    const confirmResp = await fetch('/api/confirm-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    const confirmData = await confirmResp.json();
                    if (!confirmResp.ok) {
                        console.warn('Confirm session failed:', confirmData);
                    } else {
                        console.log('Confirm session success:', confirmData);
                    }
                }
            } catch (e) {
                console.warn('Confirm session exception:', e);
            }

            // Start polling DB for live status
            await pollAndRenderStatus({ orderId, paymentId, titleEl, subEl, pillEl, homeBtn, howBtn });

            // Clear form data
            clearFormData();
        });


        // Clear form data
        function clearFormData() {
            localStorage.removeItem('songPreferences');
            localStorage.removeItem('songFormData');
            localStorage.removeItem('contactData');
        }

        // Poll and render order/payment status from DB
        async function pollAndRenderStatus({ orderId, paymentId, titleEl, subEl, pillEl, homeBtn, howBtn }) {
            const supabaseUrl = 'https://lchleopfdvrgunbrlngh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjaGxlb3BmZHZyZ3VuYnJsbmdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTYwNjgsImV4cCI6MjA3MzMzMjA2OH0.U4NkKdXFgK3Im78oz_SaEHkWQqGzhlaeA83Rom4oD7A';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            const maxAttempts = 12; // ~60s
            let attempt = 0;

            while (attempt < maxAttempts) {
                attempt++;
                try {
                    if (!orderId) break;
                    const { data, error } = await supabase
                        .from('song_requests')
                        .select('order_id,status,payment_status,payment_id,updated_at')
                        .eq('order_id', orderId)
                        .maybeSingle();
                    if (error) throw error;

                    if (data) {
                        renderByStatus({
                            status: data.status,
                            paymentStatus: data.payment_status,
                            titleEl,
                            subEl,
                            pillEl,
                            homeBtn,
                            howBtn
                        });
                        // Stop polling once we reach a terminal state
                        if ([ 'paid', 'failed', 'canceled' ].includes(String(data.status))) {
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Status poll error:', e);
                }
                await new Promise(r => setTimeout(r, 5000));
            }

            // Timeout fallback
            renderByStatus({ status: 'processing', paymentStatus: 'processing', titleEl, subEl, pillEl, homeBtn, howBtn });
        }

        function renderByStatus({ status, paymentStatus, titleEl, subEl, pillEl, homeBtn, howBtn }) {
            const normalized = String(status || paymentStatus || '').toLowerCase();
            let pillText = `status: ${normalized || 'unknown'}`;
            pillEl.textContent = pillText;

            // Enable buttons for user navigation
            homeBtn.disabled = false;
            howBtn.disabled = false;

            switch (normalized) {
                case 'paid':
                    titleEl.textContent = 'Payment Successful!';
                    subEl.textContent = 'Your order has been confirmed and payment processed successfully.';
                    pillEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 border border-green-200';
                    break;
                case 'processing':
                case 'pending':
                case 'pending_payment':
                case 'requires_action':
                    titleEl.textContent = 'Payment Processing…';
                    subEl.textContent = 'We are confirming your payment. This may take a few moments.';
                    pillEl.className = 'text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200';
                    break;
                case 'failed':
                    titleEl.textContent = 'Payment Failed';
                    subEl.textContent = 'Your payment could not be completed. Please try again or use a different method.';
                    pillEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700 border border-red-200';
                    break;
                case 'canceled':
                    titleEl.textContent = 'Payment Canceled';
                    subEl.textContent = 'Your payment was canceled. You can return to the homepage and try again any time.';
                    pillEl.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-200';
                    break;
                default:
                    titleEl.textContent = 'Finalizing your payment…';
                    subEl.textContent = 'Please wait while we confirm your payment and update your order.';
                    pillEl.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-200';
            }
        }

        // Navigation functions
        function goToHome() {
            window.location.href = 'index.html';
        }

        function goToHowItWorks() {
            window.location.href = 'how-it-works.html';
        }
    </script>
</body>
</html>
