<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ziina Payment Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px;
        }
        button:hover { background: #0056b3; }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            text-align: left;
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Ziina Payment Debug Tool</h1>
        <p>This tool helps diagnose issues with Ziina payment integration and provides detailed error information.</p>
        
        <div class="config">
            <h3>Current Configuration:</h3>
            <p><strong>API Key:</strong> ICBwiSb7cUWIBkczgyyGWMd4IqGN8kk0JdlLMylkwqA2M3BbRGhdRKbADGkHnen4</p>
            <p><strong>Base URL:</strong> https://api-v2.ziina.com/api</p>
            <p><strong>Environment:</strong> <span id="environment"></span></p>
        </div>
        
        <div class="step">
            <h3>Step 1: Environment Check</h3>
            <button onclick="checkEnvironment()">Check Environment</button>
        </div>
        
        <div class="step">
            <h3>Step 2: Test API Connection</h3>
            <button onclick="testApiConnection()">Test Ziina API</button>
        </div>
        
        <div class="step">
            <h3>Step 3: Test Payment Creation</h3>
            <button onclick="testPaymentCreation()">Create Test Payment</button>
        </div>
        
        <div class="step">
            <h3>Step 4: Test Full Payment Flow</h3>
            <button onclick="testFullPaymentFlow()">Test Complete Flow</button>
        </div>
        
        <div class="step">
            <h3>Step 5: Debug Live Payment</h3>
            <button onclick="debugLivePayment()">Debug Live Payment</button>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        // Ziina API configuration
        const ZIINA_API_KEY = 'ICBwiSb7cUWIBkczgyyGWMd4IqGN8kk0JdlLMylkwqA2M3BbRGhdRKbADGkHnen4';
        const ZIINA_BASE_URL = 'https://api-v2.ziina.com/api';

        function showResult(message, type = 'info') {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = `result ${type}`;
            result.textContent = message;
        }

        function checkEnvironment() {
            const hostname = window.location.hostname;
            const href = window.location.href;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            
            document.getElementById('environment').textContent = isLocalhost ? 'Localhost (Test Mode)' : 'Live Site (Production Mode)';
            
            showResult(`üåç Environment Analysis:

üìç Current Location: ${href}
üè† Hostname: ${hostname}
üîß Mode: ${isLocalhost ? 'Localhost (Test Mode)' : 'Live Site (Production Mode)'}

${isLocalhost ? 
    '‚úÖ LOCALHOST DETECTED\n\nExpected Behavior:\n‚Ä¢ Payment simulation (no real charges)\n‚Ä¢ No API calls to Ziina\n‚Ä¢ Redirect to success page\n‚Ä¢ No CORS errors\n\nIf you\'re getting real API errors on localhost, there\'s a configuration issue.' :
    'üåê LIVE SITE DETECTED\n\nExpected Behavior:\n‚Ä¢ Real API calls to Ziina\n‚Ä¢ Actual payment processing\n‚Ä¢ Redirect to Ziina payment page\n‚Ä¢ Real charges applied\n\nIf you\'re getting errors here, check API configuration.'}`, isLocalhost ? 'success' : 'warning');
        }

        async function testApiConnection() {
            showResult('Testing Ziina API connection...', 'info');
            
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            
            if (isLocalhost) {
                showResult('üîÑ LOCALHOST MODE\n\nSkipping real API test due to CORS restrictions.\n\nOn localhost, the payment system should:\n‚Ä¢ Simulate successful payment\n‚Ä¢ Redirect to success page\n‚Ä¢ Not make real API calls\n\nIf you\'re seeing real API errors on localhost, the localhost detection is not working properly.', 'warning');
                return;
            }
            
            try {
                // Test basic API connectivity
                const response = await fetch(`${ZIINA_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${ZIINA_API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const responseText = await response.text();
                
                showResult(`üåê API Connection Test Results:

üìä Response Status: ${response.status}
üìã Response Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}
üìù Response Body: ${responseText}

${response.ok ? 
    '‚úÖ API connection successful!' : 
    '‚ùå API connection failed. This might be normal if the health endpoint doesn\'t exist.'}

üîç Analysis:
${response.status === 200 ? '‚úÖ API is responding' : ''}
${response.status === 401 ? '‚ùå Authentication failed - check API key' : ''}
${response.status === 403 ? '‚ùå Access forbidden - check API permissions' : ''}
${response.status === 404 ? '‚ö†Ô∏è Endpoint not found - this might be normal' : ''}
${response.status >= 500 ? '‚ùå Server error - Ziina API issue' : ''}`, response.ok ? 'success' : 'error');
                
            } catch (error) {
                showResult(`‚ùå API Connection Error: ${error.message}

üîç Possible Causes:
‚Ä¢ CORS issues (normal for localhost)
‚Ä¢ Network connectivity problems
‚Ä¢ Invalid API endpoint
‚Ä¢ API key issues

üí° Solutions:
‚Ä¢ Test on live site instead of localhost
‚Ä¢ Check network connection
‚Ä¢ Verify API key is correct
‚Ä¢ Check Ziina API documentation`, 'error');
            }
        }

        async function testPaymentCreation() {
            showResult('Testing payment creation...', 'info');
            
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            
            const paymentData = {
                amount: 3150, // AED 31.50 in fils
                currency: 'AED',
                description: 'Test payment for Muzimake song creation',
                success_url: `${window.location.origin}/payment-success.html?payment_id=test_${Date.now()}`,
                cancel_url: `${window.location.origin}/create-song-step4.html`,
                test: isLocalhost, // Test mode for localhost
                metadata: {
                    order_id: 'TEST_' + Date.now(),
                    customer_name: 'Test Customer',
                    customer_email: 'test@example.com'
                }
            };
            
            if (isLocalhost) {
                showResult(`üîÑ LOCALHOST PAYMENT TEST

üìã Payment Data:
${JSON.stringify(paymentData, null, 2)}

‚úÖ Expected Behavior:
‚Ä¢ Simulate successful payment creation
‚Ä¢ Return mock payment URL
‚Ä¢ No real API calls made
‚Ä¢ Redirect to success page

‚ùå If you're getting real API errors here, the localhost detection is broken.`, 'success');
                return;
            }
            
            try {
                showResult(`üåê Creating real payment with Ziina...

üìã Payment Data:
${JSON.stringify(paymentData, null, 2)}

üîÑ Sending request to: ${ZIINA_BASE_URL}/payment_intent`, 'info');
                
                const response = await fetch(`${ZIINA_BASE_URL}/payment_intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ZIINA_API_KEY}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                showResult(`üí≥ Payment Creation Results:

üìä Response Status: ${response.status}
üìã Response Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}
üìù Response Body: ${JSON.stringify(responseData, null, 2)}

${response.ok ? 
    '‚úÖ Payment created successfully!' : 
    '‚ùå Payment creation failed'}

üîç Error Analysis:
${response.status === 400 ? '‚ùå Bad Request - check payment data format' : ''}
${response.status === 401 ? '‚ùå Unauthorized - check API key' : ''}
${response.status === 403 ? '‚ùå Forbidden - check API permissions' : ''}
${response.status === 422 ? '‚ùå Validation Error - check required fields' : ''}
${response.status >= 500 ? '‚ùå Server Error - Ziina API issue' : ''}

üí° Next Steps:
${response.ok ? 
    '‚Ä¢ Check if redirect_url is present in response\n‚Ä¢ Test redirect to payment page' : 
    '‚Ä¢ Fix the error above\n‚Ä¢ Check Ziina API documentation\n‚Ä¢ Verify payment data format'}`, response.ok ? 'success' : 'error');
                
            } catch (error) {
                showResult(`‚ùå Payment Creation Error: ${error.message}

üîç Possible Causes:
‚Ä¢ Network connectivity issues
‚Ä¢ CORS restrictions
‚Ä¢ Invalid API endpoint
‚Ä¢ Malformed request data

üí° Solutions:
‚Ä¢ Check network connection
‚Ä¢ Verify API endpoint URL
‚Ä¢ Check request format
‚Ä¢ Test with different data`, 'error');
            }
        }

        async function testFullPaymentFlow() {
            showResult('Testing complete payment flow...', 'info');
            
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            
            // Simulate the exact flow from your payment page
            const orderData = {
                orderId: 'MZ_' + Date.now(),
                fullName: 'John Doe',
                email: 'john@example.com',
                recipientName: 'Jane Smith',
                moment: 'Birthday',
                genre: 'Pop',
                gender: 'Male'
            };
            
            const paymentData = {
                amount: 3150, // AED 31.50 in fils
                currency: 'AED',
                description: `Custom song for ${orderData.recipientName} - ${orderData.moment}`,
                success_url: `${window.location.origin}/payment-success.html?order_id=${orderData.orderId}`,
                cancel_url: `${window.location.origin}/create-song-step4.html`,
                test: isLocalhost
            };
            
            showResult(`üéØ Full Payment Flow Test:

üìã Order Data:
${JSON.stringify(orderData, null, 2)}

üìã Payment Data:
${JSON.stringify(paymentData, null, 2)}

${isLocalhost ? 
    'üîÑ LOCALHOST MODE\n\n‚úÖ Expected Flow:\n1. Simulate order save to database\n2. Simulate payment creation\n3. Redirect to success page\n4. No real API calls\n\n‚ùå If you see real API errors, localhost detection is broken.' :
    'üåê LIVE SITE MODE\n\n‚úÖ Expected Flow:\n1. Save order to database\n2. Create real payment with Ziina\n3. Redirect to Ziina payment page\n4. Process real payment\n\n‚ùå If you see errors, check API configuration.'}`, isLocalhost ? 'success' : 'warning');
        }

        function debugLivePayment() {
            showResult(`üîç Live Payment Debug Guide:

If you're getting "if this issue persists contact support" error on the live site:

1Ô∏è‚É£ CHECK API KEY:
   ‚Ä¢ Verify API key is correct: ICBwiSb7cUWIBkczgyyGWMd4IqGN8kk0JdlLMylkwqA2M3BbRGhdRKbADGkHnen4
   ‚Ä¢ Check if key has proper permissions
   ‚Ä¢ Ensure key is not expired

2Ô∏è‚É£ CHECK PAYMENT DATA:
   ‚Ä¢ Amount: 3150 fils (AED 31.50)
   ‚Ä¢ Currency: AED
   ‚Ä¢ Description: Custom song message
   ‚Ä¢ Success/Cancel URLs: Valid URLs

3Ô∏è‚É£ CHECK API ENDPOINT:
   ‚Ä¢ URL: https://api-v2.ziina.com/api/payment_intent
   ‚Ä¢ Method: POST
   ‚Ä¢ Headers: Authorization: Bearer <key>

4Ô∏è‚É£ COMMON ISSUES:
   ‚ùå Invalid API key
   ‚ùå Wrong endpoint URL
   ‚ùå Incorrect payment data format
   ‚ùå Network connectivity issues
   ‚ùå Ziina API service issues

5Ô∏è‚É£ DEBUGGING STEPS:
   ‚Ä¢ Check browser console for errors
   ‚Ä¢ Test API key with Ziina support
   ‚Ä¢ Verify payment data format
   ‚Ä¢ Check network requests in DevTools

6Ô∏è‚É£ CONTACT SUPPORT:
   ‚Ä¢ If all else fails, contact Ziina support
   ‚Ä¢ Provide API key and error details
   ‚Ä¢ Share payment data format being used`, 'info');
        }

        // Auto-run environment check on page load
        window.addEventListener('load', function() {
            checkEnvironment();
        });
    </script>
</body>
</html>
