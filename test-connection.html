<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .sql-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîó Supabase Connection Test</h1>
    
    <div class="container">
        <h2>Step 1: Test Basic Connection</h2>
        <button onclick="testBasicConnection()">Test Connection</button>
        <div id="basicResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Step 2: Test Table Access</h2>
        <button onclick="testTableAccess()">Test Table Access</button>
        <div id="tableResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Step 3: Create Table (if needed)</h2>
        <button onclick="createTable()">Try to Create Table</button>
        <div id="createResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Step 4: Test Order Creation</h2>
        <button onclick="createTestOrder()">Create Test Order</button>
        <div id="orderResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Manual Setup Instructions</h2>
        <p>If automatic setup fails, follow these steps:</p>
        <ol>
            <li>Go to your Supabase dashboard: <a href="https://supabase.com/dashboard/project/ubvamxnoycciskqzbblc" target="_blank">https://supabase.com/dashboard/project/ubvamxnoycciskqzbblc</a></li>
            <li>Click "SQL Editor" in the left sidebar</li>
            <li>Click "New Query"</li>
            <li>Copy and paste the SQL code below</li>
            <li>Click "Run" to execute</li>
        </ol>
        
        <button onclick="copySQL()">Copy SQL Code</button>
        <div id="sqlCode" class="sql-code"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://lchleopfdvrgunbrlngh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjaGxlb3BmZHZyZ3VuYnJsbmdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTYwNjgsImV4cCI6MjA3MzMzMjA2OH0.U4NkKdXFgK3Im78oz_SaEHkWQqGzhlaeA83Rom4oD7A';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // SQL code for creating the table
        const sqlCode = `-- Create the song_requests table
CREATE TABLE IF NOT EXISTS song_requests (
    id SERIAL PRIMARY KEY,
    customer_name TEXT,
    customer_email TEXT,
    customer_phone TEXT,
    celebration TEXT,
    genre TEXT,
    recipient_name TEXT,
    recipient_gender TEXT,
    status TEXT DEFAULT 'pending',
    price DECIMAL(10,2),
    order_id TEXT UNIQUE,
    payment_id TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE song_requests ENABLE ROW LEVEL SECURITY;

-- Create policies for anonymous access (form submissions)
CREATE POLICY "Allow anonymous inserts" ON song_requests
    FOR INSERT WITH CHECK (true);

-- Create policies for authenticated access (admin dashboard)
CREATE POLICY "Allow authenticated read" ON song_requests
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow authenticated update" ON song_requests
    FOR UPDATE USING (auth.role() = 'authenticated');`;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sqlCode').textContent = sqlCode;
            log('Connection test page loaded. Ready to test Supabase.', 'info', 'basicResults');
        });

        function log(message, type = 'info', targetId = 'basicResults') {
            const target = document.getElementById(targetId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            target.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            target.scrollTop = target.scrollHeight;
        }

        async function testBasicConnection() {
            log('Testing basic Supabase connection...', 'info', 'basicResults');
            try {
                // Try to access the API root
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });

                if (response.ok) {
                    log('‚úÖ Basic connection successful!', 'success', 'basicResults');
                    log(`Response status: ${response.status}`, 'info', 'basicResults');
                } else {
                    log(`‚ùå Connection failed with status: ${response.status}`, 'error', 'basicResults');
                }
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error', 'basicResults');
                if (error.message.includes('Failed to fetch')) {
                    log('This might be a CORS issue or the project URL is incorrect.', 'warning', 'basicResults');
                }
            }
        }

        async function testTableAccess() {
            log('Testing table access...', 'info', 'tableResults');
            try {
                const { data, error } = await supabase
                    .from('song_requests')
                    .select('*')
                    .limit(1);

                if (error) {
                    log(`‚ùå Table access failed: ${error.message}`, 'error', 'tableResults');
                    if (error.message.includes('relation "song_requests" does not exist')) {
                        log('The table does not exist yet. We need to create it.', 'warning', 'tableResults');
                    }
                } else {
                    log('‚úÖ Table access successful!', 'success', 'tableResults');
                    log(`Found ${data.length} records`, 'info', 'tableResults');
                    if (data.length > 0) {
                        log(`Sample data: ${JSON.stringify(data, null, 2)}`, 'info', 'tableResults');
                    }
                }
            } catch (error) {
                log(`‚ùå Table access error: ${error.message}`, 'error', 'tableResults');
            }
        }

        async function createTable() {
            log('Attempting to create table...', 'info', 'createResults');
            try {
                // Try to insert a test record to see if table exists
                const testRecord = {
                    customer_name: 'Test User',
                    customer_email: 'test@example.com',
                    customer_phone: '+971501234567',
                    celebration: 'Test',
                    genre: 'Pop',
                    recipient_name: 'Test Recipient',
                    recipient_gender: 'Male',
                    status: 'test',
                    price: 31.50,
                    order_id: 'TEST_' + Date.now()
                };

                const { data, error } = await supabase
                    .from('song_requests')
                    .insert([testRecord])
                    .select();

                if (error) {
                    if (error.message.includes('relation "song_requests" does not exist')) {
                        log('‚ùå Table does not exist. Please create it manually using the SQL code below.', 'error', 'createResults');
                        log('Go to your Supabase dashboard and run the SQL script.', 'info', 'createResults');
                    } else {
                        log(`‚ùå Error: ${error.message}`, 'error', 'createResults');
                    }
                } else {
                    log('‚úÖ Table exists and test insert successful!', 'success', 'createResults');
                    log(`Inserted: ${JSON.stringify(data, null, 2)}`, 'info', 'createResults');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error', 'createResults');
            }
        }

        async function createTestOrder() {
            log('Creating test order...', 'info', 'orderResults');
            try {
                const testOrder = {
                    customer_name: 'Test Customer ' + Date.now(),
                    customer_email: 'test' + Date.now() + '@example.com',
                    customer_phone: '+971501234567',
                    celebration: 'Test Celebration',
                    genre: 'Pop',
                    recipient_name: 'Test Recipient',
                    recipient_gender: 'Male',
                    status: 'pending',
                    price: 31.50,
                    order_id: 'MZ_TEST_' + Date.now()
                };

                const { data, error } = await supabase
                    .from('song_requests')
                    .insert([testOrder])
                    .select();

                if (error) {
                    log(`‚ùå Order creation failed: ${error.message}`, 'error', 'orderResults');
                } else {
                    log('‚úÖ Test order created successfully!', 'success', 'orderResults');
                    log(`Order: ${JSON.stringify(data, null, 2)}`, 'info', 'orderResults');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error', 'orderResults');
            }
        }

        function copySQL() {
            navigator.clipboard.writeText(sqlCode).then(() => {
                log('‚úÖ SQL code copied to clipboard!', 'success', 'createResults');
            }).catch(() => {
                log('‚ùå Failed to copy. Please manually copy the SQL code.', 'error', 'createResults');
            });
        }
    </script>
</body>
</html>
