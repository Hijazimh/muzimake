<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Migration - Muzimake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Database Migration Required</h1>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold text-yellow-800 mb-2">⚠️ Action Required</h2>
                <p class="text-yellow-700">
                    Your Supabase database is missing the <code class="bg-yellow-100 px-2 py-1 rounded">story</code> and <code class="bg-yellow-100 px-2 py-1 rounded">vibe</code> columns. 
                    You need to run the migration script below to fix this issue.
                </p>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Step 1: Copy the Migration Script</h2>
                <div class="code-block mb-4" id="migrationScript">
-- Migration script to add missing columns to existing song_requests table
-- Run this SQL in your Supabase SQL Editor

-- Add missing columns to the existing song_requests table
ALTER TABLE song_requests 
ADD COLUMN IF NOT EXISTS story TEXT,
ADD COLUMN IF NOT EXISTS vibe TEXT,
ADD COLUMN IF NOT EXISTS order_id TEXT UNIQUE;

-- Create an index on order_id for better performance
CREATE INDEX IF NOT EXISTS idx_song_requests_order_id ON song_requests(order_id);

-- Update existing records to have a default order_id if they don't have one
UPDATE song_requests 
SET order_id = 'MZ' || id || '_' || EXTRACT(EPOCH FROM created_at)::bigint
WHERE order_id IS NULL;
                </div>
                <button onclick="copyScript()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Copy Script
                </button>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Step 2: Run in Supabase</h2>
                <ol class="list-decimal list-inside space-y-2 text-gray-700">
                    <li>Go to your <a href="https://supabase.com/dashboard" target="_blank" class="text-blue-500 hover:underline">Supabase Dashboard</a></li>
                    <li>Select your project: <code class="bg-gray-100 px-2 py-1 rounded">lchleopfdvrgunbrlngh</code></li>
                    <li>Go to the <strong>SQL Editor</strong> tab</li>
                    <li>Paste the migration script above</li>
                    <li>Click <strong>Run</strong> to execute the script</li>
                </ol>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Step 3: Verify the Migration</h2>
                <p class="text-gray-700 mb-3">After running the migration, you can verify it worked by running this query:</p>
                <div class="code-block mb-4">
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'song_requests' 
ORDER BY ordinal_position;
                </div>
                <p class="text-gray-700">You should see the following columns: <code class="bg-gray-100 px-2 py-1 rounded">story</code>, <code class="bg-gray-100 px-2 py-1 rounded">vibe</code>, and <code class="bg-gray-100 px-2 py-1 rounded">order_id</code></p>
            </div>

            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-green-800 mb-2">✅ After Migration</h2>
                <p class="text-green-700">
                    Once you've run the migration script, your payment flow should work correctly. 
                    The error "Could not find the 'story' column" will be resolved.
                </p>
            </div>

            <div class="mt-8 text-center">
                <a href="create-song-step4.html" class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600">
                    Test Payment Flow
                </a>
            </div>
        </div>
    </div>

    <script>
        function copyScript() {
            const script = document.getElementById('migrationScript').textContent;
            navigator.clipboard.writeText(script).then(() => {
                alert('Migration script copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }
    </script>
</body>
</html>
