<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Database Structure</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Database Structure Test</h1>
    <p>This page will help us verify the current database structure and identify what needs to be fixed.</p>

    <div class="test-section">
        <h3>Step 1: Test Current Database Connection</h3>
        <button onclick="testConnection()">Test Supabase Connection</button>
        <div id="connectionResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Check Current Table Structure</h3>
        <button onclick="checkTableStructure()">Check song_requests Table Structure</button>
        <div id="structureResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Test Audio File Update</h3>
        <button onclick="testAudioUpdate()">Test Audio File Update</button>
        <div id="updateResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Instructions</h3>
        <div id="instructions">
            <p><strong>If the test above shows errors, follow these steps:</strong></p>
            <ol>
                <li>Go to your Supabase Dashboard</li>
                <li>Open the SQL Editor</li>
                <li>Copy and paste the contents of <code>improve-audio-persistence.sql</code></li>
                <li>Run the SQL script</li>
                <li>Refresh this page and run the tests again</li>
            </ol>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Replace with your actual Supabase credentials
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<p>Testing connection...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('song_requests')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Connection Failed</h4><p>Error: ${error.message}</p><p>Please check your Supabase credentials in this file.</p></div>`;
                } else {
                    resultDiv.innerHTML = `<div class="success"><h4>‚úÖ Connection Successful</h4><p>Successfully connected to Supabase!</p></div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Connection Error</h4><p>Error: ${err.message}</p></div>`;
            }
        }

        async function checkTableStructure() {
            const resultDiv = document.getElementById('structureResult');
            resultDiv.innerHTML = '<p>Checking table structure...</p>';
            
            try {
                // Try to select from the table to see what columns exist
                const { data, error } = await supabase
                    .from('song_requests')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Error Accessing Table</h4><p>Error: ${error.message}</p></div>`;
                    return;
                }
                
                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    const audioColumns = columns.filter(col => col.includes('audio'));
                    
                    let html = '<div class="info"><h4>üìã Current Table Structure</h4>';
                    html += '<p><strong>All columns:</strong></p><pre>' + JSON.stringify(columns, null, 2) + '</pre>';
                    
                    if (audioColumns.length > 0) {
                        html += '<p><strong>Audio-related columns:</strong></p><pre>' + JSON.stringify(audioColumns, null, 2) + '</pre>';
                    } else {
                        html += '<p><strong>‚ùå No audio-related columns found!</strong></p>';
                    }
                    
                    // Check if we have the required columns
                    const requiredColumns = ['audio_file_url', 'audio_file_id', 'audio_file_name', 'audio_file_size', 'audio_uploaded_at'];
                    const missingColumns = requiredColumns.filter(col => !columns.includes(col));
                    
                    if (missingColumns.length === 0) {
                        html += '<p><strong>‚úÖ All required audio columns are present!</strong></p>';
                    } else {
                        html += '<p><strong>‚ùå Missing required columns:</strong></p><pre>' + JSON.stringify(missingColumns, null, 2) + '</pre>';
                    }
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="info"><h4>üìã Table is Empty</h4><p>No data found in song_requests table.</p></div>';
                }
                
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Error</h4><p>Error: ${err.message}</p></div>`;
            }
        }

        async function testAudioUpdate() {
            const resultDiv = document.getElementById('updateResult');
            resultDiv.innerHTML = '<p>Testing audio file update...</p>';
            
            try {
                // First, get a request ID to test with
                const { data: requests, error: fetchError } = await supabase
                    .from('song_requests')
                    .select('id')
                    .limit(1);
                
                if (fetchError) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Error Fetching Requests</h4><p>Error: ${fetchError.message}</p></div>`;
                    return;
                }
                
                if (!requests || requests.length === 0) {
                    resultDiv.innerHTML = '<div class="info"><h4>üìã No Requests Found</h4><p>Create a song request first to test audio updates.</p></div>';
                    return;
                }
                
                const testRequestId = requests[0].id;
                const testAudioData = {
                    audio_file_url: 'https://test.example.com/audio.mp3',
                    audio_file_id: 'test_audio_123',
                    audio_file_name: 'test-audio.mp3',
                    audio_file_size: 1024000,
                    audio_uploaded_at: new Date().toISOString()
                };
                
                // Try to update with audio data
                const { error: updateError } = await supabase
                    .from('song_requests')
                    .update(testAudioData)
                    .eq('id', testRequestId);
                
                if (updateError) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Audio Update Failed</h4><p>Error: ${updateError.message}</p><p>This suggests the audio columns don't exist yet.</p></div>`;
                } else {
                    resultDiv.innerHTML = `<div class="success"><h4>‚úÖ Audio Update Successful</h4><p>Successfully updated request ID ${testRequestId} with audio data!</p></div>`;
                }
                
            } catch (err) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Error</h4><p>Error: ${err.message}</p></div>`;
            }
        }

        // Auto-run connection test on page load
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>
