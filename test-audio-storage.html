<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Storage Test - Muzimake</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; background: #fc6900; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #e55a00; }
        input[type="file"] { margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üéµ Muzimake Audio Storage Test</h1>
    
    <div class="test-section">
        <h2>1. Test Storage Connection</h2>
        <button onclick="testConnection()">Test Supabase Connection</button>
        <div id="connectionResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Bucket Configuration</h2>
        <button onclick="testBucketConfig()">Check Bucket Configuration</button>
        <div id="bucketResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test File Upload</h2>
        <input type="file" id="testFile" accept="audio/*">
        <button onclick="testUpload()">Upload Test File</button>
        <div id="uploadResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Public URL Access</h2>
        <button onclick="testPublicAccess()">Test Public URL Access</button>
        <div id="publicResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Test Existing Files</h2>
        <button onclick="listExistingFiles()">List Existing Audio Files</button>
        <div id="filesResult" class="result"></div>
    </div>

    <script>
        // Supabase configuration (same as your main app)
        const supabaseUrl = 'https://your-project-id.supabase.co';
        const supabaseKey = 'your-anon-key';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let testUploadedUrl = null;
        
        async function testConnection() {
            const result = document.getElementById('connectionResult');
            result.innerHTML = '<span class="info">Testing connection...</span>';
            
            try {
                const { data, error } = await supabase.storage.listBuckets();
                if (error) throw error;
                
                result.innerHTML = `<span class="success">‚úÖ Connection successful! Found ${data.length} buckets.</span>`;
                console.log('Buckets:', data);
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Connection failed: ${error.message}</span>`;
                console.error('Connection error:', error);
            }
        }
        
        async function testBucketConfig() {
            const result = document.getElementById('bucketResult');
            result.innerHTML = '<span class="info">Checking bucket configuration...</span>';
            
            try {
                // Check if audio-files bucket exists and is public
                const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
                if (bucketsError) throw bucketsError;
                
                const audioBucket = buckets.find(b => b.id === 'audio-files');
                if (!audioBucket) {
                    result.innerHTML = '<span class="error">‚ùå audio-files bucket not found!</span>';
                    return;
                }
                
                result.innerHTML = `
                    <span class="success">‚úÖ audio-files bucket found!</span><br>
                    <span class="info">Bucket details:</span><br>
                    - ID: ${audioBucket.id}<br>
                    - Name: ${audioBucket.name}<br>
                    - Public: ${audioBucket.public ? '‚úÖ Yes' : '‚ùå No'}<br>
                    - File size limit: ${audioBucket.file_size_limit || 'Not set'}<br>
                    - Allowed MIME types: ${audioBucket.allowed_mime_types ? audioBucket.allowed_mime_types.join(', ') : 'Not set'}
                `;
                
                if (!audioBucket.public) {
                    result.innerHTML += '<br><span class="error">‚ùå BUCKET IS NOT PUBLIC! This is why email links don\'t work.</span>';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error checking bucket: ${error.message}</span>`;
                console.error('Bucket check error:', error);
            }
        }
        
        async function testUpload() {
            const fileInput = document.getElementById('testFile');
            const result = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                result.innerHTML = '<span class="error">‚ùå Please select a file first</span>';
                return;
            }
            
            const file = fileInput.files[0];
            result.innerHTML = '<span class="info">Uploading file...</span>';
            
            try {
                const fileName = `test_${Date.now()}.${file.name.split('.').pop()}`;
                
                // Upload file
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('audio-files')
                    .upload(fileName, file);
                
                if (uploadError) throw uploadError;
                
                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('audio-files')
                    .getPublicUrl(fileName);
                
                testUploadedUrl = urlData.publicUrl;
                
                result.innerHTML = `
                    <span class="success">‚úÖ Upload successful!</span><br>
                    <span class="info">File: ${fileName}</span><br>
                    <span class="info">Public URL: <a href="${testUploadedUrl}" target="_blank">${testUploadedUrl}</a></span>
                `;
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Upload failed: ${error.message}</span>`;
                console.error('Upload error:', error);
            }
        }
        
        async function testPublicAccess() {
            const result = document.getElementById('publicResult');
            
            if (!testUploadedUrl) {
                result.innerHTML = '<span class="error">‚ùå Please upload a test file first</span>';
                return;
            }
            
            result.innerHTML = '<span class="info">Testing public access...</span>';
            
            try {
                const response = await fetch(testUploadedUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    result.innerHTML = `
                        <span class="success">‚úÖ Public access works!</span><br>
                        <span class="info">Status: ${response.status}</span><br>
                        <span class="info">Content-Type: ${response.headers.get('content-type')}</span><br>
                        <span class="info">URL: <a href="${testUploadedUrl}" target="_blank">Open in new tab</a></span>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="error">‚ùå Public access failed!</span><br>
                        <span class="error">Status: ${response.status}</span><br>
                        <span class="error">URL: ${testUploadedUrl}</span>
                    `;
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Access test failed: ${error.message}</span>`;
                console.error('Access test error:', error);
            }
        }
        
        async function listExistingFiles() {
            const result = document.getElementById('filesResult');
            result.innerHTML = '<span class="info">Listing existing files...</span>';
            
            try {
                const { data: files, error } = await supabase.storage
                    .from('audio-files')
                    .list();
                
                if (error) throw error;
                
                if (files.length === 0) {
                    result.innerHTML = '<span class="info">No files found in audio-files bucket</span>';
                    return;
                }
                
                let html = `<span class="success">‚úÖ Found ${files.length} files:</span><br>`;
                
                for (const file of files) {
                    const { data: urlData } = supabase.storage
                        .from('audio-files')
                        .getPublicUrl(file.name);
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <strong>${file.name}</strong><br>
                            <span class="info">Size: ${file.metadata?.size || 'Unknown'}</span><br>
                            <span class="info">URL: <a href="${urlData.publicUrl}" target="_blank">Test Link</a></span>
                        </div>
                    `;
                }
                
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error listing files: ${error.message}</span>`;
                console.error('List files error:', error);
            }
        }
    </script>
</body>
</html>
