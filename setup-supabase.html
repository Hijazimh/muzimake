<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Setup - Muzimake</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 20px 0;
        }
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        .sql-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .copy-btn {
            background: #28a745;
            font-size: 12px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Muzimake Supabase Setup</h1>
    
    <div class="container">
        <h2>Step 1: Test Supabase Connection</h2>
        <p>Let's first test if we can connect to your Supabase project.</p>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="testTable()">Test Table Access</button>
        <div id="connectionResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Step 2: Create Database Table</h2>
        <p>If the connection works, we need to create the <code>song_requests</code> table.</p>
        
        <div class="step">
            <h3>Option A: Automatic Setup (Recommended)</h3>
            <p>Click the button below to automatically create the table:</p>
            <button onclick="createTable()">Create Table Automatically</button>
        </div>
        
        <div class="step">
            <h3>Option B: Manual Setup</h3>
            <p>If automatic setup fails, copy this SQL code and run it in your Supabase SQL Editor:</p>
            <button class="copy-btn" onclick="copySQL()">Copy SQL Code</button>
            <div id="sqlCode" class="sql-code"></div>
        </div>
        
        <div id="tableResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Step 3: Test Order Creation</h2>
        <p>Once the table is created, let's test creating a real order:</p>
        <button onclick="createTestOrder()">Create Test Order</button>
        <button onclick="loadOrders()">Load All Orders</button>
        <div id="orderResults" class="log"></div>
    </div>

    <div class="container">
        <h2>Step 4: Update Website</h2>
        <p>Once everything is working, we'll update your website to use the real database:</p>
        <button onclick="updateWebsite()">Update Website to Use Real Database</button>
        <div id="updateResults" class="log"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://ubvamxnoycciskqzbblc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidmFteG5veWNjaXNrcXpiYmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MDQ5MDMsImV4cCI6MjA3MzI4MDkwM30.5PBF0VOccNblPCbYOV7cMeAvQUKPh4pn3ob_Q-l3xfE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // SQL code for creating the table
        const sqlCode = `-- Muzimake Database Setup for Supabase
-- Run this SQL in your Supabase SQL Editor

-- Create the song_requests table
CREATE TABLE IF NOT EXISTS song_requests (
    id SERIAL PRIMARY KEY,
    customer_name TEXT,
    customer_email TEXT,
    customer_phone TEXT,
    celebration TEXT,
    genre TEXT,
    recipient_name TEXT,
    recipient_gender TEXT,
    status TEXT DEFAULT 'pending',
    price DECIMAL(10,2),
    order_id TEXT UNIQUE,
    payment_id TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_song_requests_created_at ON song_requests(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_song_requests_status ON song_requests(status);
CREATE INDEX IF NOT EXISTS idx_song_requests_order_id ON song_requests(order_id);

-- Enable Row Level Security (RLS)
ALTER TABLE song_requests ENABLE ROW LEVEL SECURITY;

-- Create policies for anonymous access (form submissions)
CREATE POLICY "Allow anonymous inserts" ON song_requests
    FOR INSERT WITH CHECK (true);

-- Create policies for authenticated access (admin dashboard)
CREATE POLICY "Allow authenticated read" ON song_requests
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow authenticated update" ON song_requests
    FOR UPDATE USING (auth.role() = 'authenticated');

-- Create a function to automatically update the updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create a trigger to automatically update the updated_at column
CREATE TRIGGER update_song_requests_updated_at 
    BEFORE UPDATE ON song_requests 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- Insert some sample data for testing
INSERT INTO song_requests (
    customer_name, 
    customer_email, 
    customer_phone, 
    celebration, 
    genre, 
    recipient_name, 
    recipient_gender, 
    status, 
    price,
    order_id
) VALUES 
(
    'Ahmed Al-Rashid',
    'ahmed@example.com',
    '+971501234567',
    'Wedding Anniversary',
    'Pop',
    'Fatima Al-Rashid',
    'Female',
    'pending',
    31.50,
    'MZ_SAMPLE_001'
),
(
    'Sarah Johnson',
    'sarah@example.com',
    '+971502345678',
    'Birthday',
    'Rock',
    'Mike Johnson',
    'Male',
    'processing',
    31.50,
    'MZ_SAMPLE_002'
) ON CONFLICT (order_id) DO NOTHING;`;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sqlCode').textContent = sqlCode;
            log('Setup page loaded. Ready to configure Supabase.', 'info', 'connectionResults');
        });

        function log(message, type = 'info', targetId = 'connectionResults') {
            const target = document.getElementById(targetId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            target.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            target.scrollTop = target.scrollHeight;
        }

        async function testConnection() {
            log('Testing Supabase connection...', 'info', 'connectionResults');
            try {
                const { data, error } = await supabase
                    .from('song_requests')
                    .select('count')
                    .limit(1);

                if (error) {
                    log(`Connection failed: ${error.message}`, 'error', 'connectionResults');
                    if (error.message.includes('relation "song_requests" does not exist')) {
                        log('Table does not exist yet. We need to create it.', 'warning', 'connectionResults');
                    }
                } else {
                    log('Connection successful!', 'success', 'connectionResults');
                    log(`Response: ${JSON.stringify(data)}`, 'info', 'connectionResults');
                }
            } catch (err) {
                log(`Connection error: ${err.message}`, 'error', 'connectionResults');
                if (err.message.includes('Failed to fetch')) {
                    log('This might be a CORS issue. Try testing from your live website instead.', 'warning', 'connectionResults');
                }
            }
        }

        async function testTable() {
            log('Testing table access...', 'info', 'connectionResults');
            try {
                const { data, error } = await supabase
                    .from('song_requests')
                    .select('*')
                    .limit(5);

                if (error) {
                    log(`Table access failed: ${error.message}`, 'error', 'connectionResults');
                } else {
                    log(`Table access successful! Found ${data.length} records`, 'success', 'connectionResults');
                    if (data.length > 0) {
                        log(`Sample data: ${JSON.stringify(data, null, 2)}`, 'info', 'connectionResults');
                    }
                }
            } catch (err) {
                log(`Table access error: ${err.message}`, 'error', 'connectionResults');
            }
        }

        async function createTable() {
            log('Attempting to create table automatically...', 'info', 'tableResults');
            try {
                // Try to create the table using a simple insert that will fail if table doesn't exist
                const testInsert = {
                    customer_name: 'Test',
                    customer_email: 'test@example.com',
                    customer_phone: '+971501234567',
                    celebration: 'Test',
                    genre: 'Test',
                    recipient_name: 'Test',
                    recipient_gender: 'Male',
                    status: 'test',
                    price: 31.50,
                    order_id: 'TEST_' + Date.now()
                };

                const { data, error } = await supabase
                    .from('song_requests')
                    .insert([testInsert])
                    .select();

                if (error) {
                    if (error.message.includes('relation "song_requests" does not exist')) {
                        log('Table does not exist. Please run the SQL script manually in your Supabase dashboard.', 'error', 'tableResults');
                        log('Go to: https://supabase.com/dashboard/project/ubvamxnoycciskqzbblc', 'info', 'tableResults');
                        log('Click "SQL Editor" â†’ "New Query" â†’ Paste the SQL code â†’ Click "Run"', 'info', 'tableResults');
                    } else {
                        log(`Error: ${error.message}`, 'error', 'tableResults');
                    }
                } else {
                    log('Table exists and test insert successful!', 'success', 'tableResults');
                    log(`Inserted: ${JSON.stringify(data)}`, 'info', 'tableResults');
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error', 'tableResults');
            }
        }

        function copySQL() {
            navigator.clipboard.writeText(sqlCode).then(() => {
                log('SQL code copied to clipboard!', 'success', 'tableResults');
                log('Now go to your Supabase dashboard and paste it in the SQL Editor.', 'info', 'tableResults');
            }).catch(() => {
                log('Failed to copy. Please manually copy the SQL code above.', 'error', 'tableResults');
            });
        }

        async function createTestOrder() {
            log('Creating test order...', 'info', 'orderResults');
            try {
                const testOrder = {
                    customer_name: 'Test Customer ' + Date.now(),
                    customer_email: 'test' + Date.now() + '@example.com',
                    customer_phone: '+971501234567',
                    celebration: 'Test Celebration',
                    genre: 'Pop',
                    recipient_name: 'Test Recipient',
                    recipient_gender: 'Male',
                    status: 'pending',
                    price: 31.50,
                    order_id: 'MZ_TEST_' + Date.now()
                };

                const { data, error } = await supabase
                    .from('song_requests')
                    .insert([testOrder])
                    .select();

                if (error) {
                    log(`Order creation failed: ${error.message}`, 'error', 'orderResults');
                } else {
                    log('Test order created successfully!', 'success', 'orderResults');
                    log(`Order: ${JSON.stringify(data, null, 2)}`, 'info', 'orderResults');
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error', 'orderResults');
            }
        }

        async function loadOrders() {
            log('Loading all orders...', 'info', 'orderResults');
            try {
                const { data, error } = await supabase
                    .from('song_requests')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    log(`Failed to load orders: ${error.message}`, 'error', 'orderResults');
                } else {
                    log(`Loaded ${data.length} orders successfully!`, 'success', 'orderResults');
                    log(`Orders: ${JSON.stringify(data, null, 2)}`, 'info', 'orderResults');
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error', 'orderResults');
            }
        }

        function updateWebsite() {
            log('Updating website to use real database...', 'info', 'updateResults');
            log('This will be done automatically when you refresh your website.', 'info', 'updateResults');
            log('The payment flow will now save real orders to Supabase!', 'success', 'updateResults');
        }
    </script>
</body>
</html>
